<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="face-api.min.js"></script>
    <style>
      body {
        display: flex;
        justify-content: center;
      }
      #overlay {
        position: absolute;
        top: 0;
        left: 0;
      }
    </style>
  </head>
  <body>
    <div style="position: relative">
      <img id="imgStream" src="face2.jpg" style="max-width: 800px" />
      <canvas id="overlay" />
    </div>
    <script>
      const socket = new WebSocket(window.location.href);
      socket.addEventListener("open", (event) => {});

      // Listen for messages
      socket.addEventListener("message", async (event) => {
        document.getElementById(
          "imgStream"
        ).src = `data:image/jpeg;base64,${event.data}`;
        await updateResults();
      });

      function getCurrentFaceDetectionNet() {
        return faceapi.nets.tinyFaceDetector;
      }

      function isFaceDetectionModelLoaded() {
        return !!getCurrentFaceDetectionNet().params;
      }

      async function changeFaceDetector(detector) {
        if (!isFaceDetectionModelLoaded()) {
          await getCurrentFaceDetectionNet().load("/");
        }
      }
      async function updateResults() {
        if (!isFaceDetectionModelLoaded()) {
          await getCurrentFaceDetectionNet().load("/");
        }

        const inputImgEl = document.getElementById("imgStream");
        const options = new faceapi.TinyFaceDetectorOptions({
          inputSize: 512,
          scoreThreshold: 0.1,
        });

        const results = await faceapi.detectAllFaces(inputImgEl, options);

        const canvas = document.getElementById("overlay");
        faceapi.matchDimensions(canvas, inputImgEl);
        faceapi.draw.drawDetections(
          canvas,
          faceapi.resizeResults(results, inputImgEl)
        );
      }

      document.addEventListener("DOMContentLoaded", updateResults);
    </script>
  </body>
</html>
